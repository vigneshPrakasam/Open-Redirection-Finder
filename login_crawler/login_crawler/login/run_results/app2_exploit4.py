#Importing Required Packages

import urllib2
import json
import time
import requests
import copy
import os
from selenium.webdriver.common.by import By
from bs4 import BeautifulSoup
from pprint import pprint
from selenium import webdriver
from selenium.webdriver.support.ui import Select
from urlparse import urlparse,parse_qs
from selenium.common.exceptions import NoSuchElementException


mydriver = webdriver.Firefox()
mydriver.get("https://app2.com/login/index.php")
mydriver.find_element_by_id('username').send_keys('admin')
mydriver.find_element_by_id('password').send_keys('AdminAdmin1!')
mydriver.find_element_by_id('loginbtn').click()
#Application SessionKey fetch
appsesskeyPayload = {u'sesskey': 'randomvalue'}

appsesskeyPayload['url'] = mydriver.current_url
session_keyword = 'sesskey'
sessK = ''
mydriver.get(appsesskeyPayload.get('url'))
pgsrc = mydriver.page_source
soup = BeautifulSoup(pgsrc)
allA = soup.find_all('a')
for indA in allA:
	if indA.get('href') is not None:
		if session_keyword in indA.get('href'):
			u = indA.get('href')
			o = urlparse(u)
			paramdict = parse_qs(o.query)
			sessK = paramdict[session_keyword][0]
			break
for skeyword in appsesskeyPayload:
	if skeyword != 'url':
		session_keyvalue = sessK


pageurl = "https://app2.com/comment/comment_post.php"
mydriver.get(pageurl)
elements = mydriver.find_elements_by_tag_name('input')
payload = {u'itemid': u'0', u'contextid': u'2', u'returnurl': u'https://www.google.com', u'area': u'page_comments', u'courseid': u'1', u'component': u'block_comments', u'sesskey': u'r9oudBHT2k', u'action': u'add'}

payload[session_keyword] = session_keyvalue

flag_successful = False
first_flag = True
for keyword in payload:
	if payload.get(keyword):
		for element in elements:
			if element.get_attribute('name') == keyword:
				flag_successful = True
				script = "return arguments[0].value = '" + payload.get(keyword) + "'"
				mydriver.execute_script(script, element)

if flag_successful:
	flag_successful = False
else:
	for keyword in payload :
		if first_flag :
			if payload.get(keyword) :
				finalurl = pageurl + "?" + keyword + "=" + payload.get(keyword)
				first_flag = False
		else:
			if payload.get(keyword):
				finalurl = finalurl + "&" + keyword + "=" + payload.get(keyword)
if first_flag is False:
	mydriver.get(finalurl)
	print finalurl
elementbtn = mydriver.find_element_by_xpath("//input[starts-with(@type,'submit')]")
elementbtn.submit()
mydriver.quit()


##END OF FILE##
